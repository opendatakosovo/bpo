{% extends 'layout.html' %}
{% block body %}
<style>
    .intro-text {
        display: none;
    }

    #mainNav {
        display: none;
    }
</style>
<link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
<script src="../static/js/highcharts/highstock.min.js"></script>
<script src="../static/js/highcharts/map-module.min.js"></script>
<script src="../static/js/highcharts/exporting-module.min.js"></script>
<script src="../static/js/highcharts/bd-all.min.js"></script>
<script src="../static/js/highcharts/stock-exporting-module.min.js"></script>
<script src="../static/js/highcharts/map-drilldown-module.min.js"></script>
<script src="../static/js/geo-files/divisions.js"></script>
<script src="../static/js/geo-files/upazillas.js"></script>

<div class="row">

    <div class="col-md-12" id="filtering">
        <div class="row">
            <div class="viz-title-container col-md-6">
                <span class="viz-title">Bangladesh Peace Observatory</span>
            </div>
            <div class="col-md-2 col-md-offset-4">
                <a class="viz-title-about" href="{{ url_for('main.about') }}">About</a>
            </div>
        </div>
        <br/>
        <div class="row">
            <div class="col-md-6 col-xs-6">
                <div class="col-md-6">
                    <div class="drillup">
                        <a class="drillup-button">Home</a>
                    </div>
                    <input name='division-select' class="form-control update-chart empty" id="division-select" value=''
                           placeholder="Search divisions, districts, upazilas              &#xF002;">

                </div>
            </div>
            <div class="col-md-2 col-xs-6">
                <label class="filter-label" for="data-source-select">Choose data source</label>
                <select class="form-control" id="data-source-select">
                    <option value="mgr">MGR</option>
                    <option value="idams">IDAMS</option>
                </select>
            </div>
            <div class="col-md-2 col-xs-6">
                <label class="filter-label" for="violence-type-select">Violence Type:</label>
                <select class="form-control update-chart" id="violence-type-select">

                </select>
            </div>
            <div class="col-md-2 col-xs-12">
                <label class="filter-label" for="daterange">Time period:</label>
                <input type="text" class="form-control update-chart" name="daterange" value=""/>
            </div>
        </div>
        <br/>
    </div>
    <div id="map" class="col-md-6">
    </div>
    <div id="viz-container" class="col-md-6">
        <div class="violent-crimes-in col-md-12">
            <span class="location-main-text">Violence in <span class="location-name">the Country</span></span>
        </div>
        <div id="national-rank" class="col-md-12">
            <span class="rank-section-title">National ranked:</span>
            <div id="national-rank-accordion">
                <div class="national-overview-tab">
                    <div class="row rank-stats">
                        <div class="col-md-4">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/deaths_black_big.png') }}"/>
                            <span class="division-death-rank-nth">n/a</span>
                            <img class="viz-icon-arrow"
                                 src="{{ url_for('static', filename='assets/down_arrow.png') }}"/>
                        </div>
                        <div class="col-md-4">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/injury_black_big.png') }}"/>
                            <span class="division-injury-rank-nth">n/a</span>
                            <img class="viz-icon-arrow" src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>
                        </div>
                        <div class="col-md-4">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/property_black_big.png') }}"/>
                            <span class="division-property-rank-nth">n/a</span>
                            <img class="viz-icon-arrow"
                                 src="{{ url_for('static', filename='assets/down_arrow.png') }}"/>
                            <span class="caret"></span>
                        </div>

                    </div>


                </div>
                <div class="rank-text">
                    <div class='rank-text-row'>
                        <div class="icon-container">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/deaths_black_big.png') }}"/>
                        </div>
                        <span class="desc-death-rank-name"></span> ranked <span class="desc-death-rank"></span> in
                        deaths with <span class="desc-death-rank-total"></span> incidents.
                    </div>
                    <br/>
                    <div class='rank-text-row'>
                        <div class="icon-container">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/injury_black_big.png') }}"/>
                        </div>
                        <span class="desc-injury-rank-name"></span> ranked <span class="desc-injury-rank"></span> in
                        injuries with <span
                            class="desc-injury-rank-total"></span> incidents.
                    </div>
                    <br/>
                    <div class='rank-text-row'>
                        <div class="icon-container">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/property_black_big.png') }}"/>
                        </div>
                        <span class="desc-property-rank-name"></span> ranked <span class="desc-property-rank"></span> in
                        property damage with <span
                            class="desc-property-rank-total"></span> incidents.
                        <i class="fa fa-caret-up rotate collapse-national-stats" aria-hidden="true"></i>
                    </div>
                    <br/>

                </div>

            </div>
        </div>
        <div id="division-rank" class="col-md-12">
            <span class="rank-section-title">Division ranked:</span>
            <div id="division-rank-accordion">
                <div class="division-overview-tab">
                    <div class="row rank-stats">
                        <div class="col-md-4">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/deaths_black_big.png') }}"/>
                            <span class="division-death-rank-nth">n/a</span>
                            <img class="viz-icon-arrow"
                                 src="{{ url_for('static', filename='assets/down_arrow.png') }}"/>
                        </div>
                        <div class="col-md-4">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/injury_black_big.png') }}"/>
                            <span class="division-injury-rank-nth">n/a</span>
                            <img class="viz-icon-arrow" src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>
                        </div>
                        <div class="col-md-4">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/property_black_big.png') }}"/>
                            <span class="division-property-rank-nth">n/a</span>
                            <img class="viz-icon-arrow"
                                 src="{{ url_for('static', filename='assets/down_arrow.png') }}"/>
                            <span class="caret"></span>
                        </div>

                    </div>


                </div>
                <div class="rank-text">
                    <div class='rank-text-row'>
                        <div class="icon-container">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/deaths_black_big.png') }}"/>
                        </div>
                        <span class="division-desc-death-rank-name"></span> ranked <span
                            class="division-desc-death-rank"></span> in
                        deaths with <span class="division-desc-death-rank-total"></span> incidents.
                    </div>
                    <br/>
                    <div class='rank-text-row'>
                        <div class="icon-container">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/injury_black_big.png') }}"/>
                        </div>
                        <span class="division-desc-injury-rank-name"></span> ranked <span
                            class="division-desc-injury-rank"></span> in
                        injuries with <span
                            class="division-desc-injury-rank-total"></span> incidents.
                    </div>
                    <br/>
                    <div class='rank-text-row'>
                        <div class="icon-container">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/property_black_big.png') }}"/>
                        </div>
                        <span class="division-desc-property-rank-name"></span> ranked <span
                            class="division-desc-property-rank"></span> in
                        property damage with <span
                            class="division-desc-property-rank-total"></span> incidents.
                        <i class="fa fa-caret-up rotate collapse-division-stats" aria-hidden="true"></i>
                    </div>
                    <br/>

                </div>

            </div>
        </div>
        <div id="district-rank" class="col-md-12">
            <span class="rank-section-title">District ranked:</span>
            <div id="district-rank-accordion">
                <div class="district-overview-tab">
                    <div class="row rank-stats">
                        <div class="col-md-4">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/deaths_black_big.png') }}"/>
                            <span class="district-death-rank-nth">n/a</span>
                            <img class="viz-icon-arrow"
                                 src="{{ url_for('static', filename='assets/down_arrow.png') }}"/>
                        </div>
                        <div class="col-md-4">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/injury_black_big.png') }}"/>
                            <span class="district-injury-rank-nth">n/a</span>
                            <img class="viz-icon-arrow" src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>
                        </div>
                        <div class="col-md-4">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/property_black_big.png') }}"/>
                            <span class="district-property-rank-nth">n/a</span>
                            <img class="viz-icon-arrow"
                                 src="{{ url_for('static', filename='assets/down_arrow.png') }}"/>
                            <span class="caret"></span>
                        </div>

                    </div>


                </div>
                <div class="rank-text">
                    <div class='rank-text-row'>
                        <div class="icon-container">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/deaths_black_big.png') }}"/>
                        </div>
                        <span class="district-desc-death-rank-name"></span> ranked <span
                            class="district-desc-death-rank"></span> in
                        deaths with <span class="district-desc-death-rank-total"></span> incidents.
                    </div>
                    <br/>
                    <div class='rank-text-row'>
                        <div class="icon-container">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/injury_black_big.png') }}"/>
                        </div>
                        <span class="district-desc-injury-rank-name"></span> ranked <span
                            class="district-desc-injury-rank"></span> in
                        injuries with <span
                            class="district-desc-injury-rank-total"></span> incidents.
                    </div>
                    <br/>
                    <div class='rank-text-row'>
                        <div class="icon-container">
                            <img class="viz-icon"
                                 src="{{ url_for('static', filename='assets/property_black_big.png') }}"/>
                        </div>
                        <span class="district-desc-property-rank-name"></span> ranked <span
                            class="district-desc-property-rank"></span> in
                        property damage with <span
                            class="district-desc-property-rank-total"></span> incidents.
                        <i class="fa fa-caret-up rotate collapse-district-stats" aria-hidden="true"></i>
                    </div>
                    <br/>

                </div>

            </div>
        </div>
        <div id="national-overview" class="col-md-12">
            <span class="section-title">National Overview:</span>
            <div id="national-accordion">
                <div class="division-overview-tab">
                    <div class="icon-container">
                        <img class="viz-icon" src="{{ url_for('static', filename='assets/deaths_black_big.png') }}"/>
                    </div>

                    <span class="rate-1"></span><span class="rate-text"> has the </span> <span class="rate-1-text">highest fatality rate. </span>
                    <img class="rate-1-arrow viz-icon-arrow"
                         src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>

                    <span class="caret"></span>
                </div>
                <div>
                    <div class="third-section-chart" id="third-section-first-chart">
                    </div>
                    <span class="third-section-first-chart-no-data">

                    </span>
                </div>
                <div class="division-overview-tab">
                    <div class="icon-container">
                        <img class="viz-icon" src="{{ url_for('static', filename='assets/injury_black_big.png') }}"/>
                    </div>
                    <span class="rate-2"></span><span class="rate-text"> has the </span>  <span class="rate-2-text">highest injury count.</span>
                    <img class="rate-2-arrow viz-icon-arrow"
                         src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>
                    <span class="caret"></span>
                </div>
                <div>
                    <div class="third-section-chart" id="third-section-second-chart">
                    </div>
                    <span class="third-section-second-chart-no-data">

                    </span>
                </div>
                <div class="division-overview-tab">
                    <div class="icon-container">
                        <img class="viz-icon" src="{{ url_for('static', filename='assets/property_black_big.png') }}"/>
                    </div>
                    <span class="rate-3"></span><span class="rate-text"> has the </span>  <span class="rate-3-text">highest property damage count.</span>
                    <img class="rate-3-arrow viz-icon-arrow"
                         src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>
                    <span class="caret"></span>
                </div>
                <div>
                    <div class="third-section-chart" id="third-section-third-chart">
                    </div>
                    <span class="third-section-third-chart-no-data">

                    </span>
                </div>
            </div>
        </div>

        <script>

        </script>
        <div id="top" class="col-md-12">
            <div class="col-md-6 top-3">
                <span class="section-title-top-perpetrators">Top 3 Reported Perpetrators</span>
                <ol id="perpetrators-list">
                </ol>
                <span class="perpetrators-list-not-enogh-data">
                    Not enough data.
                </span>
            </div>
            <div class="col-md-6 top-3">
                <span class="section-title-top-casualties">Top 3 Reported Casualties</span>
                <ol id="casualties-list">
                </ol>
                <span class="casualties-list-not-enogh-data">
                    Not enough data.
                </span>
            </div>
            <div class="col-md-6 top-3">
                <span class="section-title-top-property">Top 3 Property Type Destruction</span>
                <ol id="property-list">
                </ol>
                <span class="property-list-not-enogh-data">
                    Not enough data.
                </span>
            </div>
        </div>
        <div class="col-md-12">
            <div class="col-md-12 census-information">
                <div class="col-md-12">
                    <span style="color: #03506b;font-size: 16px;">Census Information for <span class="location-name">Bangladesh</span></span>
                </div>

                <div class="col-md-6">
                    <dl class="dl-horizontal">
                        <dt>Population</dt>
                        <dd class="population-data">n/a</dd>
                    </dl>
                    <dl class="dl-horizontal second-dl">
                        <dt> -</dt>
                        <dd> -</dd>
                    </dl>
                    <!--<dl class="dl-horizontal second-dl">-->
                    <!--<dt>Unemployment</dt>-->
                    <!--<dd class="unemployment-data">n/a</dd>-->
                    <!--</dl>-->
                    <!--<dl class="dl-horizontal">-->
                    <!--<dt>Literacy</dt>-->
                    <!--<dd class="literacy-data">n/a</dd>-->
                    <!--</dl>-->
                    <dl class="dl-horizontal">
                        <dt>Poverty</dt>
                        <dd class="poverty-data">n/a</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <dl class="dl-horizontal">
                        <dt>Religious diversity</dt>
                        <dd>Muslim: n/a</dd>
                    </dl>
                    <dl class="dl-horizontal">
                        <dt></dt>
                        <dd>Hindu: n/a</dd>
                    </dl>
                    <dl class="dl-horizontal">
                        <dt></dt>
                        <dd>Buddhist: n/a</dd>
                    </dl>
                    <dl class="dl-horizontal">
                        <dt></dt>
                        <dd>Christian: n/a</dd>
                    </dl>
                    <dl class="dl-horizontal">
                        <dt></dt>
                        <dd>Others: n/a</dd>
                    </dl>
                </div>

            </div>
        </div>

    </div>

</div>

<div class="row">
    <div id="line-chart" class="col-md-12">
        <span class="line-chart-title">Human and Economic Impact</span><br/>
        <span class="line-chart-description">State of Violence in <span class="location-name">Bangladesh</span></span>
        <div id="line-chart-container">

        </div>
    </div>

</div>
<script type="text/javascript" src="{{ url_for('static', filename='json/bangladesh.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='json/locations.js') }}"></script>
<script>
    var allData = undefined;
    var global_division = '';
    var global_district = '';
    var global_upazila = '';
    $(document).ready(function () {
        jQuery.ajaxSetup({async: false});

        buildViolenceTypeDropDown();

        // Build the date range input so we can select FROM - TO daterange
        buildDateRangeInput();

        // Init and build the map
        buildMap();

        // Build searxh box
        buildSearchBox();

        // Init the right death,injuries,property charts
        initCharts();

        // Init the jQuery UI accordions
        initAccordions();

        // Resize charts on window resize
        initResizeChartsOnResizeWindow();

        $('.drillup-button').text("Home");
        $('.highcharts-drillup-button').on('change', function () {
            if($($('.highcharts-drillup-button')[0]).length !=0){
                $('.drillup .drillup-button ').text($($('.highcharts-drillup-button')[0])[0]['textContent']);
            }else{
                $('.drillup-button').text("Home");
            }

        });
        $('.drillup-button').click(function () {
            $('.highcharts-drillup-button').click();
            if($('.drillup-button').text() == "‚óÅ Back to Bangladesh"){
                var home_url = "{{ url_for('main.index')}}";
                $('.drillup-button').text("Home");
            }
            if($($('.highcharts-drillup-button')[0]).length !=0){
                $('.drillup .drillup-button ').text($($('.highcharts-drillup-button')[0])[0]['textContent']);
            }else{
                $('.drillup-button').text("Home");
            }
        });

        // Build the ranking on the right on location based stats
        buildRankingBasedOnLocation();

        // Populate location searchbox dropdown list
        populateLocationDropdown();

        // Init and build the violence type dropdown list
        $('#violence-type-select [value="Attack"]').attr('selected', true);
        $('.update-chart').change(function () {
            allData = getData();
            updateViz(undefined, false);
        });
        $('#data-source-select').change(function () {
            buildViolenceTypeDropDown();
            allData = getData();
            updateViz(undefined, false);
        });

        // Populate the global allData variable
        allData = getData();

        // Init and build the national data, so when the user first lands on the page we have some data.
        buildNationalData();

        // Init and create the bottom line chart
        createLineChart();
    });

    function initResizeChartsOnResizeWindow() {
        $(window).resize(function () {
            $("#third-section-first-chart").highcharts().setSize($('#national-accordion').width(), '180', doAnimation = true);
            $("#third-section-second-chart").highcharts().setSize($('#national-accordion').width(), '180', doAnimation = true);
            $("#third-section-third-chart").highcharts().setSize($('#national-accordion').width(), '180', doAnimation = true);
            $("#map").highcharts().setSize($("#map").width(), $("#map").height(), doAnimation = true);
        });
    }

    function initAccordions() {
        // Initialize the right accordions
        $("#national-accordion").accordion({
            collapsible: true, active: false
        });
        $("#national-rank-accordion").accordion({
            collapsible: true, active: false,
            autoHeight: true
        });
        $("#district-rank-accordion").accordion({
            collapsible: true, active: false,
            autoHeight: true
        });
        $("#division-rank-accordion").accordion({
            collapsible: true, active: false,
            autoHeight: true
        });
    }
    function buildRankingBasedOnLocation() {

        // National stats accordion
        $('#national-rank-accordion .national-overview-tab').click(function () {
            $('#national-rank-accordion .national-overview-tab').hide();
        });
        $('.collapse-national-stats').click(function () {
            $('#national-rank-accordion .national-overview-tab').click();
            $('#national-rank-accordion .national-overview-tab').show();
        });

        // Division stats accordion
        $('#division-rank-accordion .division-overview-tab').click(function () {
            $('#division-rank-accordion .division-overview-tab').hide();
        });
        $('.collapse-division-stats').click(function () {
            $('#division-rank-accordion .division-overview-tab').click();
            $('#division-rank-accordion .division-overview-tab').show();
        });

        // District stats accordion
        $('#district-rank-accordion .district-overview-tab').click(function () {
            $('#district-rank-accordion .district-overview-tab').hide();
        });
        $('.collapse-district-stats').click(function () {
            $('#district-rank-accordion .district-overview-tab').click();
            $('#district-rank-accordion .district-overview-tab').show();
        });
    }
    function buildSearchBox() {

    }
    function populateLocationDropdown() {
        // Listen when we change the division/Update the visualizer reflecting the selected division data
        var availableTags = [];

        $.each(grouped_locations_list, function (i, item) {
            availableTags.push(item.division + ', ' + item.district + ', ' + item.upazila)
        });
        $("#division-select").autocomplete({
            source: availableTags,
            select: function (event, ui) {
                selected_vals = ui.item.label.split(',');
                doDrillDown(selected_vals);
                $('.drillup .drillup-button ').text($($('.highcharts-drillup-button')[0])[0]['textContent']);
                updateViz(selected_district, true);
            }
        });
        $('#division-select').change(function () {
            console.log(this.val);
        })

    }
    function doDrillDown(dDownArray) {
        $('.highcharts-drillup-button').click();
        $('.highcharts-drillup-button').click();
        $.each(dDownArray, function (item) {
            if (item < 2) {
                var map_data_ = $('#map').highcharts().series[0].data;
                $.each(map_data_, function (index) {
                    if (map_data_[index]['name'] == dDownArray[item].trim()) {
                        map_data_[index].doDrilldown();
                    }
                });
            }

        });

    }
    function initCharts() {

        var categories = [
            'Jan',
            'Feb',
            'Mar',
            'Apr',
            'May',
            'Jun',
            'Jul',
            'Aug',
            'Sep',
            'Oct',
            'Nov',
            'Dec'
        ]

        var deaths_data_series = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        var injuries_data_series = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        var property_damage_data_series = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]

        var width = $("#third-section-first-chart").width();
        var chart_options = {
            renderTo: 'chart',
            type: 'column',
            margin: 70,
            height: 180,
            defaultSeriesType: 'areaspline'
        }

        Highcharts.chart('third-section-first-chart', {
            chart: chart_options,
            title: {
                text: ''
            },
            xAxis: {
                tickPixelInterval: 50,
                categories: categories,
                crosshair: true
            },
            yAxis: {
                gridLineWidth: 0,
                minorGridLineWidth: 0,
                min: 0,
                position: 'right',
                title: {
                    text: 'Number'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="padding:0"><b>{point.y}</b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                series: {
                    stacking: 'normal',
                    borderWidth: 0
                },
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: [{
                name: "Deaths",
                data: deaths_data_series

            }]
        });
        Highcharts.chart('third-section-second-chart', {
            chart: chart_options,
            title: {
                text: ''
            },
            xAxis: {
                categories: categories,
                crosshair: true
            },
            yAxis: {
                min: 0,
                position: 'right',
                title: {
                    text: 'Number'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="padding:0"><b>{point.y}</b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: [{
                name: 'Injuries',
                data: injuries_data_series

            }]
        });
        Highcharts.chart('third-section-third-chart', {
            chart: chart_options,
            title: {
                text: ''
            },
            xAxis: {
                categories: categories,
                crosshair: true
            },
            yAxis: {
                min: 0,
                position: 'right',
                title: {
                    text: 'Number'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="padding:0"><b>{point.y}</b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: [{
                name: 'Property damage',
                data: property_damage_data_series

            }]
        });

    }
    function buildNationalData() {
        var rank_data = allData['rank-stats'];
        // Get selected violence type dropdown
        var violence_type = $("#violence-type-select").val().replace('/', '-');
        // Get date
        var date = $('input[name=daterange]').val().replace(/\//g, '-').replace(/\ /g, '-');
        // Set the highest rates
        var top_death_location = getTopN(rank_data, 'death', 1)[0].name;
        var top_injury_location = getTopN(rank_data, 'injury', 1)[0].name;
        var top_property_damage_location = getTopN(rank_data, 'property', 1)[0].name;
        $('.rate-1').html(top_death_location);
        $('.rate-2').html(top_injury_location);
        $('.rate-3').html(top_property_damage_location);

        updateCharts();

        updateTop3Section('Bangladesh', 0, violence_type, date);
        updateRankSections();
    }
    function getData() {

        var dataResults = undefined;
        var division = "";
        var district = "";
        var upazila = "";
        if ($('#map').highcharts().drilldownLevels != undefined) {
            if ($('#map').highcharts().drilldownLevels.length == 2) {
                district = $('#map').highcharts().drilldownLevels[1].lowerSeriesOptions.name;
                global_district = district;
                division = $('#map').highcharts().drilldownLevels[0].lowerSeriesOptions.name;
                global_division = division;
            } else if ($('#map').highcharts().drilldownLevels.length == 1) {
                division = $('#map').highcharts().drilldownLevels[0].lowerSeriesOptions.name
                global_division = division;
            }

        }

        // Get the selected dataset
        var dataset = $('#data-source-select').val();

        // Get selected violence type dropdown
        var violence_type = $("#violence-type-select").val().replace('/', '-');

        // Get date
        var date = $('input[name=daterange]').val().replace(/\//g, '-').replace(/\ /g, '-');

        var jsonData = {
            "division": division,
            "district": district,
            "upazila": upazila,
            "date": date,
            "violence_type": violence_type,
            "dataset": dataset,
            "period": "monthly"
        }
        $.ajax('{{ url_for("api.search")}}', {
            type: "POST",
            contentType: 'application/json',
            data: JSON.stringify(jsonData),
            beforeSend: function() {
              $('#loadingmessage').show();
            },
            success: function (data) {
                dataResults = data;
                $('#loadingmessage').hide();
            }
        });
        return dataResults;
    }
    function updateRankSections() {
        var rank_data = allData['stats'];
        if (global_division != '') {
            $('#division-rank').css('display', '');
        } else {
            $('#division-rank').css('display', 'none');
        }
        if (global_district != '') {
            $('#district-rank').css('display', '');
        } else {
            $('#district-rank').css('display', 'none');
        }
        var types = ['division', 'district', 'upazila'];
        $.each(types, function (item) {
            $.each(rank_data[types[item]]['death'], function (i, property) {
                if (global_division == property['name'] || global_district == property['name']) {
                    $('.' + types[item] + '-death-rank-nth').text(property['rank'] + 'th');
                    $('.' + types[item] + '-desc-death-rank-name').text(property['name']);
                    $('.' + types[item] + '-desc-death-rank').text(property['rank']);
                    $('.' + types[item] + '-desc-death-rank-total').text(Math.round(property['total']));
                }

            });

            $.each(rank_data[types[item]]['injury'], function (i, property) {
                if (global_division == property['name'] || global_district == property['name']) {
                    $('.' + types[item] + '-injury-rank-nth').text(property['rank'] + 'th');
                    $('.' + types[item] + '-desc-injury-rank-name').text(property['name']);
                    $('.' + types[item] + '-desc-injury-rank').text(property['rank']);
                    $('.' + types[item] + '-desc-injury-rank-total').text(Math.round(property['total']));
                }
            });
            $.each(rank_data[types[item]]['property'], function (i, property) {
                if (global_division == property['name'] || global_district == property['name']) {

                    $('.' + types[item] + '-property-rank-nth').text(property['rank'] + 'th');
                    $('.' + types[item] + '-desc-property-rank-name').text(property['name']);
                    $('.' + types[item] + '-desc-property-rank').text(property['rank']);
                    $('.' + types[item] + '-desc-property-rank-total').text(Math.round(property['total']));
                }
            });
        });


    }
    function createLineChart() {
        var seriesOptions = [];
        var seriesCounter = 0;
        var names = ['Deaths', 'Injuries', 'Incidents', 'Property Damage'];

        /**
         * Create the chart when all data is loaded
         * @returns {undefined}
         */
        function createChart(seriesOptions) {

            Highcharts.stockChart('line-chart-container', {

                rangeSelector: {
                    selected: 5
                },

                yAxis: {
                    labels: {
                        formatter: function () {
                            return this.value;
                        }
                    },
                    plotLines: [{
                        value: 0,
                        width: 2,
                        color: 'silver'
                    }]
                },
                xAxis: {
                    range: 12 * 30 * 24 * 3600 * 1000
                },
                plotOptions: {

                    series: {
                        compare: 'value',
                        showInNavigator: true,
                    }
                },

                tooltip: {
                    pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b><br/>',
                    valueDecimals: 0,
                    split: true
                },
                legend: {

                    enabled: true,
                    showCheckbox: true,
                    align: 'right',
                    backgroundColor: '#fff',
                    borderColor: 'black',
                    borderWidth: 2,
                    layout: 'horizontal',
                    verticalAlign: 'right',
                    y: 0,
                    x: -320,
                    shadow: true,
                    symbolWidth: 5
                },
                series: seriesOptions,

            });
        }

        $.each(names, function (i, name) {
            var deaths = [];
            var injuries = [];
            var incidents = [];
            var property_damage = [];
            var data = allData['daily-stats'];
            $.each(data, function (item) {
                if (data[item]['date'] != null) {
                    deaths.push([data[item]['date'].$date, data[item]['death']])
                    injuries.push([data[item]['date'].$date, data[item]['injuries']])
                    property_damage.push([data[item]['date'].$date, data[item]['property']])
                    incidents.push([data[item]['date'].$date, data[item]['incidents']])
                }
            })

            if (name == 'Deaths') {
                seriesOptions[i] = {
                    name: name,
                    data: deaths
                };
            }
            if (name == 'Injuries') {
                seriesOptions[i] = {
                    name: name,
                    data: injuries
                };
            }

            if (name == 'Incidents') {
                seriesOptions[i] = {
                    name: name,
                    data: incidents
                };
            }

            if (name == 'Property Damage') {
                seriesOptions[i] = {
                    name: name,
                    data: property_damage
                };
            }

            // As we're loading the data asynchronously, we don't know what order it will arrive. So
            // we keep a counter and create the chart when all the data is loaded.
            seriesCounter += 1;

            if (seriesCounter === names.length) {
                createChart(seriesOptions);
            }
        });

    }

    function updateLineChart() {
        var deaths = [];
        var injuries = [];
        var incidents = [];
        var property_damage = [];
        var data = allData['daily-stats'];
        $.each(data, function (item) {
            if (data[item]['date'] != null) {
                deaths.push([data[item]['date'].$date, data[item]['death']])
                injuries.push([data[item]['date'].$date, data[item]['injuries']])
                property_damage.push([data[item]['date'].$date, data[item]['property']])
                incidents.push([data[item]['date'].$date, data[item]['incidents']])
            }
        })
        $.each(Highcharts.charts, function (item) {
            if (Highcharts.charts[item].renderTo.id == 'line-chart-container') {
                $.each(Highcharts.charts[item].series, function (index) {
                    var name = Highcharts.charts[item].series[index].name;
                    if (name == 'Deaths') {
                        Highcharts.charts[item].series[index].setData(deaths);
                    } else if ('Injuries') {
                        Highcharts.charts[item].series[index].setData(injuries);
                    } else if ('Incidents') {
                        Highcharts.charts[item].series[index].setData(incidents);
                    } else if ('Property Damage') {
                        Highcharts.charts[item].series[index].setData(property_damage);
                    }
                });
                Highcharts.charts[item].redraw();
            }
        });
    }
    function buildDateRangeInput() {
        // Add daterange jquery functionality
        $('input[name="daterange"]').daterangepicker({
            locale: {
                format: 'MM-DD-YYYY'
            },
            startDate: "01-01-2014",
            endDate: "12-31-2015"
        });
    }
    function buildMap() {
        var map_data = buildDataSeries();
        /*
         TODO:
         - Check data labels after drilling. Label rank? New positions?
         - Not US Mainland text
         - Separators
         */
        var mapData = Highcharts.maps['countries/bd/bd-all'];
        var myData = Highcharts.geojson(Highcharts.maps['countries/bd/bd-all']);
        var tempSeries;

        // Some responsiveness
        var small = $('#map').width() < 400;

        // Set drilldown pointers
        $.each(myData, function (i) {
            this['hc-key'] = this.properties['hc-key'];
            this.drilldown = this.properties['name'];
            if (map_data['division'][this.name] != undefined) {
                this.value = map_data['division'][this.name];
            } else {
                this.value = null;
            }
            this.location_type = 'division';
            this.level = 1;
        });

        // Instanciate the map
        $('#map').highcharts('Map', {
            chart: {
                events: {
                    drilldown: function (e) {
                        map_data = buildDataSeries();
                        var map_key;
                        var drilldown_level = e.point.level;
                        if (drilldown_level == 1) {
                            map_key = 'countries/bd/bd-districts-all';
                        } else if (drilldown_level == 2) {
                            map_key = 'countries/bd/bd-upazillas-all';
                        }
                        var chart = this;
                        var name = e.point.name;
                        // Font Awesome spinner

                        // Load the drilldown map
                        var data = Highcharts.maps[map_key];
                        var drillMyData = Highcharts.geojson(data);
                        var drilldown_data = [];

                        // Set a non-random bogus value

                        $.each(drillMyData, function (i) {
                            if (drilldown_level == 1) {
                                if (this.properties['Division'] == name) {
                                    this['hc-key'] = "bd-" + this.properties['District'].substr(0, 2).toLowerCase();
                                    this.name = this.properties['District'];
                                    if (map_data['district'][this.name] != undefined) {
                                        this.value = map_data['district'][this.name];
                                    } else {
                                        this.value = null;
                                    }
                                    this.drilldown = this.properties.District;
                                    this.level = 2;
                                    drilldown_data.push(this);
                                }
                            } else if (drilldown_level == 2) {
                                if (this.properties.District == name) {
                                    this['hc-key'] = "bd-" + this.properties['Upazila'].substr(0, 2).toLowerCase();
                                    this.name = this.properties['Upazila'];
                                    if (map_data['upazila'][this.name] != undefined) {
                                        this.value = map_data['upazila'][this.name];
                                    } else {
                                        this.value = null;
                                    }
                                    this.level = 3;
                                    drilldown_data.push(this);
                                }
                            }
                        });

                        chart.addSeriesAsDrilldown(e.point, {
                            name: e.point.name,
                            data: drilldown_data.slice(0, drillMyData.length),
                            joinBy: 'hc-key',
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}'
                            }
                        });
                        // Hide loading and add series
                        chart.hideLoading();


                        this.setTitle(null, {text: e.point.name});
                    },
                    drillup: function (e) {
                        updateViz(e.seriesOptions.name, false);
                    }
                }
            },

            title: {
                text: ' '
            },

            subtitle: {
                text: '',
                floating: true,
                align: 'right',
                y: 50,
                style: {
                    fontSize: '16px'
                }
            },

            legend: small ? {} : {
                title: {
                    text: "No of Incidents"
                },
                itemStyle: {
                    'font-family': "Noto Serif",
                    'font-size': '14px !important',
                    'font-weight': 'bold',
                    'line-height': '19px',
                    'color': '#333333'
                },
                layout: 'vertical',
                borderWidth: 1,
                shadow: '-1px 2px 2px 0 rgba(0, 0, 0, 0.2)',
                borderRadius: 2,
                align: 'right',
                verticalAlign: 'top',
                y: -5,
                labelFormatter: function () {
                    if (this.from === undefined) {
                        return 'Below ' + this.to;
                    }

                    if (this.to === undefined) {
                        return 'Above ' + this.from;
                    }

                    return this.from + ' to ' + this.to;
                }
            },

            colorAxis: {
                dataClasses: [{
                    to: 100,
                    color: "#a3dbb9"
                }, {
                    from: 101,
                    to: 500,
                    color: "#fbfa20"
                }, {
                    from: 501,
                    to: 1000,
                    color: "#f8c733"
                }, {
                    from: 1001,
                    to: 1500,
                    color: "#feb126"
                }, {
                    from: 1501,
                    to: 2000,
                    color: "#f7802d"
                }, {
                    from: 2001,
                    color: "#fe363c"
                }]
            },

            mapNavigation: {
                enableMouseWheelZoom: false,
                enabled: true,
                buttonOptions: {
                    verticalAlign: 'bottom'
                }
            },

            plotOptions: {
                map: {
                    states: {
                        hover: {
                            color: '#a1a1a1'
                        }
                    }
                },
                series: {
                    point: {
                        events: {
                            click: function (i) {
                                if (i.target.className.baseVal.split(' ')[1] != undefined) {
                                    var clicked_point = capitalize(i.target.className.baseVal.split(' ')[1].split('-')[2]);
                                    $('#division-select [value="' + clicked_point + '"]').attr('selected', true);
                                    allData = getData();
                                    updateViz(clicked_point, false);
                                    $('.drillup-button').show();
                                    $('.drillup .drillup-button ').text($($('.highcharts-drillup-button')[0])[0]['textContent']);
                                    $('g.highcharts-button.highcharts-drillup-button.highcharts-button-normal').css('display', 'none');
                                    allData = getData();
                                    return clicked_point;
                                } else {
                                    var clicked_point = $(i.target)[0].textContent;
                                    $('#division-select [value="' + clicked_point + '"]').attr('selected', true);
                                    allData = getData();
                                    updateViz(clicked_point, false);
                                    $('.drillup-button').show();
                                    $('.drillup .drillup-button ').text($($('.highcharts-drillup-button')[0])[0]['textContent']);
                                    $('g.highcharts-button.highcharts-drillup-button.highcharts-button-normal').css('display', 'none');
                                    allData = getData();
                                    return clicked_point;
                                }
                            }
                        }
                    }
                }
            },

            series: [{
                data: myData,
                mapData: mapData,
                joinBy: 'name',
                name: 'Bangladesh',
                dataLabels: {
                    enabled: true,
                    format: '{point.name}'
                },

            }],

            drilldown: {
                //series: drilldownSeries,
                activeDataLabelStyle: {
                    color: '#FFFFFF',
                    textDecoration: 'none',
                    textShadow: '0 0 3px #000000'
                },
                drillUpButton: {
                    relativeTo: 'spacingBox',
                    position: {
                        x: 0,
                        y: -20
                    },
                    event: {
                        change: function () {
                        }
                    }
                }
            }
        });

    }
    function updateViz(name) {

        // Get selected violence type dropdown
        var violence_type = $("#violence-type-select").val().replace('/', '-');

        // Get date
        var date = $('input[name=daterange]').val().replace(/\//g, '-').replace(/\ /g, '-');

        // Get the map instance
        var the_map = $('#map').highcharts();

        // Get the drilldown level number
        level_number = 0;
        if ('drilldownLevels' in $('#map').highcharts()) {
            var level_number = $('#map').highcharts().drilldownLevels.length;
        }


        if (name == undefined) {
            name = $('#map').highcharts().series[0].name;
        }
        // If we are in the country version we should build national data visualizer

        updateTextValues();
        updateCharts()
        updateMapValues();
        updateLineChart();
        updateRankSections();
        updateTop3Section();

        // To be refactored
        updateCensusInfo(name, level_number);


    }
    function updateCensusInfo(name, level) {
        var url = '{{ url_for("api.get_census_info", name="NAME", level=10)}}'.replace('NAME', name).replace('10', level);
        $.get(url, function (data) {
            if (data != null) {
                $('.population-data').text(data['population']);
                if (data['poverty'] != null) {
                    $('.poverty-data').css('display', '');
                    $('.poverty-data').text(data['poverty'] + "%");
                } else {
                    $('.poverty-data').css('display', 'none');
                }
            }
        });
    }
    // Update the text trend values reflecting the selections
    function updateTextValues() {
        //Instantiate rank_data array
        var rank_data = allData['rank-stats'];

        // Get top death location name
        death_top_rank_data = getTopN(rank_data, 'death', 1);
        var top_death_location = "";
        if (death_top_rank_data.length != 0) {
            $('.rate-1-text').html('has the highest fatality rate.')

            $('#accordion .rate-1').parent().removeClass("ui-state-disabled");
            top_death_location = death_top_rank_data[0].name;
            $('.rate-1').html(top_death_location);
        } else {
            $('.rate-1').html("");
            $('#' + $('#accordion .rate-1').parent().id).collapse()
            $('.rate-1-text').html('Not enough data');
            $('#accordion .rate-1').parent().addClass("ui-state-disabled");
        }

        // Get top injury location name
        injury_top_rank_data = getTopN(rank_data, 'injury', 1)
        var top_injury_location = "";
        if (injury_top_rank_data.length != 0) {
            $('.rate-2-text').html('has the highest injury count.');
            $('#accordion .rate-2').parent().removeClass("ui-state-disabled");
            top_injury_location = injury_top_rank_data[0].name;
            $('.rate-2').html(top_injury_location);
        } else {
            $('.rate-2').html("");
            $('#accordion .rate-2').parent().attr("aria-expanded", false);
            $('.rate-2-text').html('Not enough data');
            $('#accordion .rate-2').parent().addClass("ui-state-disabled");
        }

        // Get top property damage location name
        property_top_rank_data = getTopN(rank_data, 'property', 1);
        var top_property_damage_location = "";
        if (property_top_rank_data.length != 0) {
            $('.rate-3-text').html('has the highest property damage count.');
            $('#accordion .rate-3').parent().removeClass("ui-state-disabled");
            top_property_damage_location = property_top_rank_data[0].name;
            $('.rate-3').html(top_property_damage_location);
        } else {
            $('.rate-3').html("");
            $('#accordion .rate-3').parent().attr("aria-expanded", false);
            $('.rate-3-text').html('Not enough data');
            $('#accordion .rate-3').parent().addClass("ui-state-disabled");
        }

        $('.location-name').html(name);

        // Change the presentation text based on the level
        if (global_division != "" && global_district == "") {
            $('.section-title').text('National Overview');
        }
        else if (global_district != "") {
            $('.section-title').text('Division Overview');
        }
        else {
            $('.section-title').text('District Overview');
        }
    }

    // Update charts in the accordions reflecting the selections
    function updateCharts() {
        // Get date
        var date = $('input[name=daterange]').val().replace(/\//g, '-').replace(/\ /g, '-');
        var new_date = date.split('---');
        var timeDiff = Math.abs((new Date(new_date[0])).getTime() - (new Date(new_date[1])).getTime())
        var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
        if (diffDays <= 365) {
            var data = allData['monthly-stats'];
            var data_series_array = Array.apply(null, Array(12)).map(Number.prototype.valueOf, 0);
            var categories = [
                'Jan',
                'Feb',
                'Mar',
                'Apr',
                'May',
                'Jun',
                'Jul',
                'Aug',
                'Sep',
                'Oct',
                'Nov',
                'Dec'
            ]
            $.each(Highcharts.charts, function (item) {
                if (Highcharts.charts[item].renderTo.id == 'third-section-first-chart') {

                    // Update third-section-first-chart values
                    $.each(data, function (item) {
                        if (data[item].death != 0) {
                            data_series_array[parseInt(data[item].month) - 1] = data[item].death;
                        }
                    });

                    // Populate data series array and show the message if there is no data
                    if (data_series_array.reduce(add, 0) != 0) {
                        $('#accordion .rate-1').parent().removeClass("ui-state-disabled");
                        Highcharts.charts[item].series[0].setData(data_series_array);
                        Highcharts.charts[item].xAxis[0].setCategories(categories);
                        updateTrendArrows(data_series_array, 1);
                        Highcharts.charts[item].hideLoading();
                    } else {
                        $('#accordion .rate-1').parent().addClass("ui-state-disabled");
                        data_series_array = Array.apply(null, Array(12)).map(Number.prototype.valueOf, 0);
                        Highcharts.charts[item].series[0].setData(data_series_array);
                        Highcharts.charts[item].showLoading('No data to display');

                    }

                    // Reset data series array
                    data_series_array = Array.apply(null, Array(12)).map(Number.prototype.valueOf, 0);
                }
                if (Highcharts.charts[item].renderTo.id == 'third-section-second-chart') {

                    // Update third-section-second-chart values
                    $.each(data, function (item) {
                        data_series_array[parseInt(data[item].month) - 1] = data[item].injuries;
                    });

                    // Populate data series array and show the message if there is no data
                    if (data_series_array.reduce(add, 0) != 0) {
                        $('#accordion .rate-2').parent().removeClass("ui-state-disabled");
                        Highcharts.charts[item].series[0].setData(data_series_array);
                        Highcharts.charts[item].xAxis[0].setCategories(categories);
                        updateTrendArrows(data_series_array, 2);
                        Highcharts.charts[item].hideLoading();
                    } else {
                        $('#accordion .rate-2').parent().addClass("ui-state-disabled");
                        // Reset data series array
                        data_series_array = Array.apply(null, Array(12)).map(Number.prototype.valueOf, 0);
                        Highcharts.charts[item].series[0].setData(data_series_array);
                        Highcharts.charts[item].showLoading('No data to display');
                    }

                    // Reset data series array
                    data_series_array = Array.apply(null, Array(12)).map(Number.prototype.valueOf, 0);
                }
                if (Highcharts.charts[item].renderTo.id == 'third-section-third-chart') {
                    // Update third-section-third-chart values
                    $.each(data, function (item) {
                        data_series_array[parseInt(data[item].month) - 1] = data[item].property;
                    });

                    // Populate data series array and show the message if there is no data
                    if (data_series_array.reduce(add, 0) != 0) {
                        $('#accordion .rate-3').parent().removeClass("ui-state-disabled");
                        Highcharts.charts[item].series[0].setData(data_series_array);
                        Highcharts.charts[item].xAxis[0].setCategories(categories);
                        updateTrendArrows(data_series_array, 3);
                        $('.rate-3-text .not-enough-data-for-chart-rate-3').remove();
                        Highcharts.charts[item].hideLoading();
                    } else {
                        $('#accordion .rate-3').parent().addClass("ui-state-disabled");
                        data_series_array = Array.apply(null, Array(12)).map(Number.prototype.valueOf, 0);
                        Highcharts.charts[item].series[0].setData(data_series_array);
                        Highcharts.charts[item].showLoading('No data to display');
                    }

                    // Reset data series array
                    data_series_array = Array.apply(null, Array(12)).map(Number.prototype.valueOf, 0);
                }

            })
        } else {
            var data = allData['quarterly-stats'];
            var third_section_third_chart = $('#third-section-third-chart').highcharts();
            var years = [];
            var data_series_array_chart = [];

            // Build the data series and categories for the charts
            $.each(data, function (item) {
                years.push(data[item].year);
            });
            years = Array.from(new Set(years));

            $.each(years, function (item) {
                data_series_array_chart.push.apply(data_series_array_chart, [0, 0, 0, 0]);
            });

            data_series_array_categories = [];
            $.each(years, function (item) {
                $.each([1, 2, 3, 4], function (index) {
                    data_series_array_categories.push("Q" + (index + 1) + " " + years[item].toString().slice(-2));
                    ;
                });
            });

            $.each(Highcharts.charts, function (item) {

                if (Highcharts.charts[item].renderTo.id == 'third-section-first-chart') {
                    // Populate data series array
                    $.each(data, function (itemIndex) {
                        var data_index = years.indexOf(data[itemIndex].year) * 4 + (data[itemIndex].quarter - 1);
                        data_series_array_chart[data_index] = data[itemIndex].death;
                    });

                    // Let's check if we have data and remove the red warning messages
                    if (data_series_array_chart.reduce(add, 0) != 0) {
                        $('#accordion .rate-1').parent().removeClass("ui-state-disabled");
                        Highcharts.charts[item].series[0].setData(data_series_array_chart);
                        Highcharts.charts[item].xAxis[0].setCategories(data_series_array_categories);
                        $('.not-enough-data-for-chart-rate-1').css('display', 'none');
                        updateTrendArrows(data_series_array_chart, 1);
                        Highcharts.charts[item].hideLoading();
                    }
                    else {
                        $('#accordion .rate-1').parent().addClass("ui-state-disabled");
                        // Reset data series array
                        data_series_array_chart = [];
                        $.each(years, function (item) {
                            data_series_array_chart.push.apply(data_series_array_chart, [0, 0, 0, 0]);
                        });
                        Highcharts.charts[item].series[0].setData(data_series_array_chart);
                        Highcharts.charts[item].showLoading('No data to display');
                    }

                    // Reset data series array
                    data_series_array_chart = [];
                    $.each(years, function (item) {
                        data_series_array_chart.push.apply(data_series_array_chart, [0, 0, 0, 0]);
                    });
                }
                if (Highcharts.charts[item].renderTo.id == 'third-section-second-chart') {

                    // Populate data series array
                    $.each(data, function (itemIndex) {
                        var data_index = years.indexOf(data[itemIndex].year) * 4 + (data[itemIndex].quarter - 1);
                        data_series_array_chart[data_index] = data[itemIndex].injuries;

                    });

                    // Let's check if we have data and remove the red warning messages
                    if (data_series_array_chart.reduce(add, 0) != 0) {
                        $('#accordion .rate-2').parent().removeClass("ui-state-disabled");
                        Highcharts.charts[item].series[0].setData(data_series_array_chart);
                        Highcharts.charts[item].xAxis[0].setCategories(data_series_array_categories);
                        updateTrendArrows(data_series_array_chart, 2);
                        Highcharts.charts[item].hideLoading();
                    }
                    else {
                        $('#accordion .rate-2').parent().addClass("ui-state-disabled");
                        data_series_array_chart = [];
                        $.each(years, function (item) {
                            data_series_array_chart.push.apply(data_series_array_chart, [0, 0, 0, 0]);
                        });
                        Highcharts.charts[item].series[0].setData(data_series_array_chart);
                        Highcharts.charts[item].showLoading('No data to display');
                    }

                    // Reset data series array
                    data_series_array_chart = [];
                    $.each(years, function (item) {
                        data_series_array_chart.push.apply(data_series_array_chart, [0, 0, 0, 0]);
                    });

                }
                if (Highcharts.charts[item].renderTo.id == 'third-section-third-chart') {
                    // Populate data series array
                    $.each(data, function (itemIndex) {
                        var data_index = years.indexOf(data[itemIndex].year) * 4 + (data[itemIndex].quarter - 1);
                        data_series_array_chart[data_index] = data[itemIndex].property;

                    });

                    // Let's check if we have data and remove the red warning messages
                    if (data_series_array_chart.reduce(add, 0) != 0) {
                        $('#accordion .rate-3').parent().removeClass("ui-state-disabled");
                        Highcharts.charts[item].series[0].setData(data_series_array_chart);
                        updateTrendArrows(data_series_array_chart, 3);
                        Highcharts.charts[item].xAxis[0].setCategories(data_series_array_categories);
                        Highcharts.charts[item].hideLoading();
                    }
                    else {
                        $('#accordion .rate-3').parent().addClass("ui-state-disabled");
                        data_series_array_chart = [];
                        $.each(years, function (item) {
                            data_series_array_chart.push.apply(data_series_array_chart, [0, 0, 0, 0]);
                        });
                        Highcharts.charts[item].series[0].setData(data_series_array_chart);
                        Highcharts.charts[item].showLoading('No data to display');
                    }
                    // Reset data series array
                    data_series_array_chart = [];
                    $.each(years, function (item) {
                        data_series_array_chart.push.apply(data_series_array_chart, [0, 0, 0, 0]);
                    });
                }

            });
        }


    }

    // Update trend arrays
    function updateTrendArrows(array, chartNumber) {
        if (array[array.length - 1] > array[array.length - 2]) {
            $('.rate-' + chartNumber + '-arrow').css('display', '');
            $('.rate-' + chartNumber + '-arrow')[0].src = $('.rate-2-arrow')[0].src.replace('down', 'up');
        } else if (array[array.length - 1] < array[array.length - 2]) {
            $('.rate-' + chartNumber + '-arrow')[0].src = $('.rate-2-arrow')[0].src.replace('up', 'down');
        }
        else if (array[array.length - 1] == array[array.length - 2]) {
            $('.rate-' + chartNumber + '-arrow').css('display', 'none');
        }
    }

    // Update the top 3 types
    function updateTop3Section() {
        // Update the Top 3 values

        var data = allData['top-3'];
        if (data.perpetrator.length != 0) {
            var perpetrators = [];
            $('#perpetrators-list').css('display', '');
            $('.perpetrators-list-not-enogh-data').css('display', 'none');
            $.each(data.perpetrator, function (i, item) {
                perpetrators.push('<li>' + item['perpetrator'] + '</li>');

            });  // close each()

            // Clear list and populate
            $('#perpetrators-list li').remove();
            $('#perpetrators-list').append(perpetrators.join(''));
        } else {
            $('#perpetrators-list').css('display', 'none');
            $('.perpetrators-list-not-enogh-data').css('display', 'block');
        }

        if (data.casualties.length != 0) {
            $('#casualties-list').css('display', '');
            $('.casualties-list-not-enogh-data').css('display', 'none');
            var casualties = [];
            $.each(data.casualties, function (i, item) {
                casualties.push('<li>' + item['casualty'] + '</li>');
            });  // close each()

            // Clear list and populate
            $('#casualties-list li').remove();
            $('#casualties-list').append(casualties.join(''));
        } else {
            $('#casualties-list').css('display', 'none');
            $('.casualties-list-not-enogh-data').css('display', 'block');
        }

        if (data.property.length != 0) {
            $('#property-list').css('display', '');
            $('.property-list-not-enogh-data').css('display', 'none');
            var property = [];
            $.each(data.property, function (i, item) {
                property.push('<li>' + item['property'] + '</li>');
            });  // close each()

            // Clear list and populate
            $('#property-list li').remove();
            $('#property-list').append(property.join(''));
        } else {
            $('#property-list').css('display', 'none');
            $('.property-list-not-enogh-data').css('display', 'block');
        }
    }

    // Get max json item based on an array of JSON's
    function getTopN(arr, prop, n) {
        // clone before sorting, to preserve the original array
        var clone = arr.slice(0);

        // sort descending
        clone.sort(function (x, y) {
            if (x[prop] == y[prop]) return 0;
            else if (parseInt(x[prop]) < parseInt(y[prop])) return 1;
            else return -1;
        });

        return clone.slice(0, n || 1);
    }

    // Add 2 values
    function add(a, b) {
        return a + b;
    }

    // Populate violence type with the distinct values from the database
    function buildViolenceTypeDropDown() {
        // Get violence dropdown options instance
        var violence_options = $("#violence-type-select");
        var url = '{{ url_for("api.get_violence_types", dataset="dataset")}}'.replace('dataset', $('#data-source-select').val());
        // Get request to get the violence types
        $.get(url, function (data) {
            violence_options.empty();
            $.each(data, function (item) {
                violence_options.append($("<option />").val(data[item]).text(data[item]));
            });
        });
    }

    // Capitalize a string
    function capitalize(s) {
        return s[0].toUpperCase() + s.slice(1);
    }
    function updateMapValues() {

        var map = $('#map').highcharts(),
                points = map.series[0].points;

        var data = allData['incident-stats'];
        var values_array = {};
        for (var item in data) {
            values_array[data[item]['name'].toString()] = data[item]["incidents"]
        }
        for (var i in points) {
            var val = values_array[points[i].name]

            if (val != undefined) {
                points[i].update({value: val}, false);
                points[i].update({color: mapColor(val)})
            } else {
                points[i].update({value: undefined}, true);
                points[i].update({color: mapColor(0)})
            }

        }
        map.redraw();
    }

    function mapColor(val) {
        if (val < 100 && val != 0) {
            return "#a3dbb9"
        }


        if (val > 100 && val < 500) {
            return "#fbfa20"
        }
        if (val > 500 && val < 1500) {
            return "#feb126"
        }


        if (val > 1500 && val < 2000) {
            return "#f7802d"
        }


        if (val > 2000) {
            return "#fe363c"
        }


        if (val == 0) {
            return "#ffffff"
        }

    }
    // Build map data series based on the incident number number
    function buildDataSeries(name) {
        var json_data = {};
        var divisions = {};
        var districts = {};
        var upazilas = {};
        // Get selected violence type dropdown
        var violence_type = $("#violence-type-select").val().replace('/', '-');

        // Get date
        var date = $('input[name=daterange]').val().replace(/\//g, '-').replace(/\ /g, '-');

        if (name == undefined) {
            name = 'Bangladesh';
        }
        var division_url = "{{ url_for('api.get_victims', type='division', date='DATE', violence_type='violence', name='Bangladesh')}}".replace('DATE', date).replace('violence', violence_type).replace('Bangladesh', name);
        $.get(division_url, function (data) {
            for (var item in data) {
                divisions[data[item]['division'].toString()] = data[item]["incidents"]
            }
        });

        var district_url = "{{ url_for('api.get_victims', type='district', date='DATE', violence_type='violence', name='Bangladesh')}}".replace('DATE', date).replace('violence', violence_type).replace('Bangladesh', name);

        $.get(district_url, function (data) {
            for (var item in data) {
                districts[data[item]['district'].toString()] = data[item]["incidents"]
            }
        });

        var upazila_url = "{{ url_for('api.get_victims', type='upazila', date='DATE', violence_type='violence', name='Bangladesh')}}".replace('DATE', date).replace('violence', violence_type).replace('Bangladesh', name);

        $.get(upazila_url, function (data) {
            for (var item in data) {
                upazilas[data[item]['upazila']] = data[item]["incidents"]
            }
        });
        json_data['division'] = divisions;
        json_data['district'] = districts;
        json_data['upazila'] = upazilas;
        return json_data;
    }
</script>
<div id='loadingmessage' style='display:none'>
  <img src='{{ url_for("static", filename="assets/loading.gif")}}'/>
</div>
{% endblock %}