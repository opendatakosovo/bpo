{% extends 'layout.html' %}
{% block body %}
<style>
    .container {
        display: none;
    }

    #mainNav {
        display: none;
    }
</style>
<link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
<script src="../static/js/highcharts/highstock.min.js"></script>
<script src="../static/js/highcharts/map-module.min.js"></script>
<script src="../static/js/highcharts/exporting-module.min.js"></script>
<script src="../static/js/highcharts/bd-all.min.js"></script>
<script src="../static/js/highcharts/stock-exporting-module.min.js"></script>
<script src="../static/js/highcharts/map-drilldown-module.min.js"></script>
<script src="../static/js/geo-files/divisions.js"></script>
<script src="../static/js/geo-files/upazillas.js"></script>

<div class="row">
    <div class="col-md-12" id="filtering">
        <br/>
        <div class="row">
            <div class="col-md-6 col-xs-6">
                <label class="filter-label" for="division-select">Barisal Division</label>
                <select class="form-control" id="division-select">
                    <option value="Dhaka">Dhaka</option>
                    <option value="Sylhet">Sylhet</option>
                    <option value="Chittagong">Chittagong</option>
                    <option value="Barisal">Barisal</option>
                    <option value="Khulna">Khulna</option>
                    <option value="Rajshahi">Rajshahi</option>
                </select>
            </div>
            <div class="col-md-2 col-xs-6">
                <label class="filter-label" for="data-source-select">Data Source</label>
                <select class="form-control" id="data-source-select">
                    <option value="mgr">MGR</option>
                    <option value="idams" disabled>IDAMS</option>

                </select>
            </div>
            <div class="col-md-2 col-xs-6">
                <label class="filter-label" for="violence-type-select">Violence Type</label>
                <select class="form-control" id="violence-type-select">

                </select>
            </div>
            <div class="col-md-2 col-xs-6">
                <label class="filter-label" for="daterange">Time Period</label>
                <input type="text" class="form-control" name="daterange" value="01/01/2015 - 01/31/2015"/>

            </div>
        </div>
        <br/>
    </div>
    <div id="map" class="col-md-6">
        MAP
    </div>
    <div id="viz-container" class="col-md-6">
        <div class="col-md-12">
            <span class="location-main-text">Violent Crimes in <span class="location-name">the Country</span></span>
        </div>

        <!--<div class="col-md-12">-->
            <!--<h3>National Ranked: <span class="national-ranked"></span>d</h3>-->
            <!--<div id="national-accordion">-->
                <!--<div>-->
                    <!--<img class="viz-icon" src="{{ url_for('static', filename='assets/deaths_black_big.png') }}"/>-->
                    <!--<span class="rate-1"></span> has the highest fatality rate.-->
                    <!--<img class="viz-icon-arrow" src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>-->
                    <!--<span class="caret"></span>-->
                <!--</div>-->
                <!--<div>-->
                    <!--<div>-->
                        <!--<img class="viz-icon"-->
                             <!--src="{{ url_for('static', filename='assets/deaths_black_big.png') }}"/>-->
                        <!--<span class="rate-2"></span> has the highest fatality rate.-->
                        <!--<img class="viz-icon-arrow" src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>-->
                        <!--<span class="caret"></span>-->
                    <!--</div>-->
                    <!--<div>-->
                        <!--<img class="viz-icon"-->
                             <!--src="{{ url_for('static', filename='assets/deaths_black_big.png') }}"/>-->
                        <!--<span class="rate-3"></span> has the highest fatality rate.-->
                        <!--<img class="viz-icon-arrow" src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>-->
                        <!--<span class="caret"></span>-->
                    <!--</div>-->
                <!--</div>-->

            <!--</div>-->
        <!--</div>-->
        <div class="col-md-12">
            <span class="section-title">National Overview:</span>
            <div id="accordion">
                <div class="division-overview-tab">
                    <img class="viz-icon" src="{{ url_for('static', filename='assets/deaths_black_big.png') }}"/>
                    <span class="rate-1"></span> has the highest fatality rate.
                    <img class="viz-icon-arrow" src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>
                    <span class="caret"></span>
                </div>
                <div>
                    <p>
                    <div class="third-section-chart" id="third-section-first-chart">
                    </div>
                    </p>
                </div>
                <div class="division-overview-tab">
                    <img class="viz-icon" src="{{ url_for('static', filename='assets/injury_black_big.png') }}"/>
                    <span class="rate-2"></span> has the highest injury count.
                    <img class="viz-icon-arrow" src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>
                    <span class="caret"></span>
                </div>
                <div>
                    <div class="third-section-chart" id="third-section-second-chart">
                    </div>
                </div>
                <div class="division-overview-tab">
                    <img class="viz-icon" src="{{ url_for('static', filename='assets/property_black_big.png') }}"/>
                    <span class="rate-3"></span> has the highest property damage count.
                    <img class="viz-icon-arrow" src="{{ url_for('static', filename='assets/up_arrow.png') }}"/>
                    <span class="caret"></span>
                </div>
                <div>
                    <div class="third-section-chart" id="third-section-third-chart">
                    </div>
                </div>
            </div>
        </div>
        <script>
            $("#accordion").accordion({
                collapsible: true, active: false,
                autoHeight: true
            });
        </script>
        <div class="col-md-12">
            <div class="col-md-6 top-3">
                <span class="section-title">Top 3 Reported Perpetrators</span>
                <ol>
                    <li>Allahr Dol</li>
                    <li>Gono Mukti Front</li>
                    <li>Other Militant Group</li>
                </ol>
            </div>
            <div class="col-md-6 top-3">
                <span class="section-title">Top 3 Reported Casualties</span>
                <ol>
                    <li>Women</li>
                    <li>General Public</li>
                    <li>Hindu Minority</li>
                </ol>
            </div>
            <div class="col-md-6 top-3">
                <span class="section-title">Top 3 Property Type Destruction</span>
                <ol>
                    <li>Cars</li>
                    <li>Public property</li>
                    <li>Shops</li>
                </ol>
            </div>
        </div>
        <!--<div class="row">-->
            <!--<div class="col-md-12 census-information">-->
                    <!--<span class="section-title">Census Information for Barisal Division<span-->
                            <!--class="caret"></span></span>-->
                <!--<div class="col-md-6">-->
                    <!--<dl class="dl-horizontal">-->
                        <!--<dt>Population</dt>-->
                        <!--<dd>149,112,243</dd>-->
                    <!--</dl>-->
                    <!--<dl class="dl-horizontal">-->
                        <!--<dt>Population</dt>-->
                        <!--<dd>149,112,243</dd>-->
                    <!--</dl>-->
                    <!--<dl class="dl-horizontal">-->
                        <!--<dt>Population</dt>-->
                        <!--<dd>149,112,243</dd>-->
                    <!--</dl>-->
                    <!--<dl class="dl-horizontal">-->
                        <!--<dt>Population</dt>-->
                        <!--<dd>149,112,243</dd>-->
                    <!--</dl>-->
                <!--</div>-->
                <!--<div class="col-md-6">-->
                    <!--<dl class="dl-horizontal">-->
                        <!--<dt>Population</dt>-->
                        <!--<dd>149,112,243</dd>-->
                    <!--</dl>-->
                    <!--<dl class="dl-horizontal">-->
                        <!--<dt>Population</dt>-->
                        <!--<dd>149,112,243</dd>-->
                    <!--</dl>-->
                    <!--<dl class="dl-horizontal">-->
                        <!--<dt>Population</dt>-->
                        <!--<dd>149,112,243</dd>-->
                    <!--</dl>-->
                    <!--<dl class="dl-horizontal">-->
                        <!--<dt>Population</dt>-->
                        <!--<dd>149,112,243</dd>-->
                    <!--</dl>-->
                <!--</div>-->

            <!--</div>-->
        <!--</div>-->

    </div>

</div>

<div class="row">
    <div id="line-chart" class="col-md-12">
        <h3>Human and Economic Impact</h3>
        <h4>State of Violence in Barisal Division</h4>
        <div style="width:100%; height:200px;" id="line-chart-container">

        </div>
    </div>

</div>
<script>


    $(document).ready(function () {
        jQuery.ajaxSetup({async: false});
        buildViolenceTypeDropDown();
        buildDateRangeInput();
        buildMap();
        createChart();
        Highcharts.chart('third-section-first-chart', {
            chart: {
                renderTo: 'chart',
                type: 'column',
                margin: 60,
                height: 200,
                defaultSeriesType: 'areaspline'
            },
            title: {
                text: ''
            },
            xAxis: {
                categories: [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'
                ],
                crosshair: true
            },
            yAxis: {
                min: 0,
                position: 'right',
                title: {
                    text: 'Number'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="padding:0"><b>{point.y}</b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: [{
                name: "Deaths",
                data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]

            }]
        });
        Highcharts.chart('third-section-second-chart', {
            chart: {
                renderTo: 'chart',
                type: 'column',
                margin: 60,
                height: 200,
                defaultSeriesType: 'areaspline'

            },
            title: {
                text: ''
            },
            xAxis: {
                categories: [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'
                ],
                crosshair: true
            },
            yAxis: {
                min: 0,
                position: 'right',
                title: {
                    text: 'Number'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="padding:0"><b>{point.y}</b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: [{
                name: 'Injuries',
                data: [0,0,0,0,0,0,0,0,0,0,0,0]

            }]
        });
        Highcharts.chart('third-section-third-chart', {
            chart: {
                renderTo: 'chart',
                type: 'column',
                margin: 60,
                height: 200,
                defaultSeriesType: 'areaspline'
            },
            title: {
                text: ''
            },
            xAxis: {
                categories: [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'
                ],
                crosshair: true
            },
            yAxis: {
                min: 0,
                position: 'right',
                title: {
                    text: 'Number'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="padding:0"><b>{point.y}</b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: [{
                name: 'Property damage',
                data: [0,0,0,0,0,0,0,0,0,0,0,0]

            }]
        });

        $('#division-select').change(function () {
            updateViz($(this).val(), true);
        });

        $("#national-accordion").accordion({
            collapsible: true, active: false
        });

        buildNationalData();
        $("#violence-type-select").change(function(){
            updateViz(undefined, false);
        })
    });
    function buildNationalData(){
        var rank_data;
        // Get request for the ranking data
        $.get('{{ url_for("api.get_rank", type="division")}}', function (data) {
            rank_data = data;
        });

//        $('.location-name').html("Bangladesh");
        $('.national-ranked').parent().css("display","none");

        // Set the highest rates
        var top_death_location = getTopN(rank_data, 'death', 1)[0].name;
        var top_injury_location = getTopN(rank_data, 'injury', 1)[0].name;
        var top_property_damage_location = getTopN(rank_data, 'property', 1)[0].name;
        $('.rate-1').html(top_death_location);
        $('.rate-2').html(top_injury_location);
        $('.rate-3').html(top_property_damage_location);
    }
    function createChart() {

        var seriesOptions = [],
                seriesCounter = 0,
                names = ['MSFT', 'AAPL', 'GOOG'];

        /**
         * Create the chart when all data is loaded
         * @returns {undefined}
         */

        Highcharts.stockChart('line-chart-container', {

            rangeSelector: {
                selected: 4
            },

            yAxis: {
                labels: {
                    formatter: function () {
                        return (this.value > 0 ? ' + ' : '') + this.value + '%';
                    }
                },
                plotLines: [{
                    value: 0,
                    width: 2,
                    color: 'silver'
                }]
            },

            plotOptions: {
                series: {
                    compare: 'percent',
                    showInNavigator: true
                }
            },

            tooltip: {
                pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.change}%)<br/>',
                valueDecimals: 2,
                split: true
            },

            series: seriesOptions
        });
    }
    function buildDateRangeInput() {
        // Add daterange jquery functionality
        $('input[name="daterange"]').daterangepicker({
            "dateLimit": {
                "months": 3
            },
        });
    }


    function buildMap() {
        var map_data = buildDataSeries();
        /*
         TODO:
         - Check data labels after drilling. Label rank? New positions?
         - Not US Mainland text
         - Separators
         */
        var mapData = Highcharts.maps['countries/bd/bd-all'],
                myData = Highcharts.geojson(Highcharts.maps['countries/bd/bd-all']),
                tempSeries,
                // Some responsiveness
                small = $('#map').width() < 400;

        // Set drilldown pointers
        $.each(myData, function (i) {
            this['hc-key'] = this.properties['hc-key'];
            this.drilldown = this.properties['name'];
            if (map_data['division'][this.name] != undefined) {
                this.value = map_data['division'][this.name];
            } else {
                this.value = null;
            }
            this.level = 1;
        });

        // Instanciate the map
        $('#map').highcharts('Map', {
            chart: {
                events: {
                    drilldown: function (e) {
                        var map_key;
                        var drilldown_level = e.point.level;
                        if (drilldown_level == 1) {
                            map_key = 'countries/bd/bd-districts-all';
                        } else if (drilldown_level == 2) {
                            map_key = 'countries/bd/bd-upazillas-all';
                        }
                        var chart = this;
                        var name = e.point.name;
                        // Font Awesome spinner

                        // Load the drilldown map

                        var data = Highcharts.maps[map_key];
                        var drillMyData = Highcharts.geojson(data);
                        var drilldown_data = [];
                        // Set a non-random bogus value

                        $.each(drillMyData, function (i) {
                            if (drilldown_level == 1) {
                                if (this.properties['Division'] == name) {
                                    this['hc-key'] = "bd-" + this.properties['District'].substr(0, 2).toLowerCase();
                                    this.name = this.properties['District'];
                                    if (map_data['district'][this.name] != undefined) {
                                        this.value = map_data['district'][this.name];
                                    } else {
                                        this.value = null;
                                    }
                                    this.drilldown = this.properties.District;
                                    this.level = 2;
                                    drilldown_data.push(this);
                                }
                            } else if (drilldown_level == 2) {
                                if (this.properties.District == name) {
                                    this['hc-key'] = "bd-" + this.properties['Upazila'].substr(0, 2).toLowerCase();
                                    this.name = this.properties['Upazila'];
                                    if (map_data['upazilla'][this.name] != undefined) {
                                        this.value = map_data['upazilla'][this.name];
                                    } else {
                                        this.value = null;
                                    }
                                    this.level = 3;
                                    drilldown_data.push(this);
                                }
                            }
                        });

                        chart.addSeriesAsDrilldown(e.point, {
                            name: e.point.name,
                            data: drilldown_data.slice(0, drillMyData.length),
                            joinBy: 'hc-key',
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}'
                            }
                        });
                        // Hide loading and add series
                        chart.hideLoading();


                        this.setTitle(null, {text: e.point.name});
                    },
//                    drillup: function () {
//                        this.setTitle(null, {text: 'Bangladesh'});
//                    }
                }
            },

            title: {
                text: 'Highcharts Map Drilldown'
            },

            subtitle: {
                text: '',
                floating: true,
                align: 'right',
                y: 50,
                style: {
                    fontSize: '16px'
                }
            },

            legend: small ? {} : {
                title: {
                    text: "No of Incidents"
                },
                itemStyle: {
                    fontSize: '10px'
                },
                layout: 'vertical',
                borderColor: "gray",
                borderWidth: 1,
                align: 'right',
                verticalAlign: 'top',
                y: 70,
                labelFormatter: function () {
                    if (this.from === undefined) {
                        return 'Below ' + this.to;
                    }

                    if (this.to === undefined) {
                        return 'Above ' + this.from;
                    }

                    return this.from + ' to ' + this.to;
                }
            },

            colorAxis: {
                dataClasses: [{
                    to: 100,
                    color: "#a3dbb9"
                }, {
                    from: 101,
                    to: 500,
                    color: "#fbfa20"
                }, {
                    from: 501,
                    to: 1000,
                    color: "#f8c733"
                }, {
                    from: 1001,
                    to: 1500,
                    color: "#feb126"
                }, {
                    from: 1501,
                    to: 2000,
                    color: "#f7802d"
                }, {
                    from: 2001,
                    color: "#fe363c"
                }]
            },

            mapNavigation: {
                enableMouseWheelZoom: false,
                enabled: true,
                buttonOptions: {
                    verticalAlign: 'bottom'
                }
            },

            plotOptions: {
                map: {
                    states: {
                        hover: {
                            color: '#a1a1a1'
                        }
                    }
                },
                series: {
                    point: {
                        events: {
                            click: function (i) {
                                if (i.target.className.baseVal.split(' ')[1] != undefined) {
                                    var clicked_point = capitalize(i.target.className.baseVal.split(' ')[1].split('-')[2]);
                                    $('#division-select [value="' + clicked_point + '"]').attr('selected', true);
                                    updateViz(clicked_point, false);
                                } else {
                                    var clicked_point = $(i.target)[0].textContent;
                                    $('#division-select [value="' + clicked_point + '"]').attr('selected', true);
                                    updateViz(clicked_point, false);
                                }

                            }
                        }
                    }
                }
            },

            series: [{
                data: myData,
                mapData: mapData,
                joinBy: 'name',
                name: 'Bangladesh',
                dataLabels: {
                    enabled: true,
                    format: '{point.name}'
                },

            }],

            drilldown: {
                //series: drilldownSeries,
                activeDataLabelStyle: {
                    color: '#FFFFFF',
                    textDecoration: 'none',
                    textShadow: '0 0 3px #000000'
                },
                drillUpButton: {
                    relativeTo: 'spacingBox',
                    position: {
                        x: 0,
                        y: 30
                    }
                }
            }
        });

    }
    function updateViz(name, from_selection) {

        var violence_type = $("#violence-type-select").val();

        // Get the map instance
        var the_map = $('#map').highcharts();

        // Get the drilldown level number
        var level_number = $(the_map)[0].drilldownLevels.length;

        //Instantiate rank_data array
        var rank_data = [];

        if(name == undefined){
            name = the_map.series[0].name;
        }
        var rank_api_url = '{{ url_for("api.get_results", name="name", level=0, violence_type="violence-type")}}';
        rank_api_url = rank_api_url.replace('name', name).replace(0, level_number-1).replace('violence-type', violence_type);

        // Get request for the ranking data
        $.get(rank_api_url, function (data) {
            rank_data = data;
        });

        // Get the selected locaion name
        var selected_name = name;

        // If we change the name in the location input
        if(from_selection == true){
            if(level_number==2){
                $('.highcharts-drillup-button').click();
            }
              var map_data_ = $(the_map)[0].series[0].data;
            $.each(map_data_, function (index) {
                if (map_data_[index]['name'] == selected_name) {
                    map_data_[index].doDrilldown();
                }
            });
        }
        // Fill values of the right visualizer
        $.each(rank_data, function (item) {
            if (rank_data[item]['name'] == selected_name) {
                $('.national-ranked').html(rank_data[item]['rank']);
            }
        });
       // Set the highest rates
        var top_death_location = getTopN(rank_data, 'death', 1)[0].name;
        var top_injury_location = getTopN(rank_data, 'injury', 1)[0].name;
        var top_property_damage_location = getTopN(rank_data, 'property', 1)[0].name;
        $('.rate-1').html(top_death_location);
        $('.rate-2').html(top_injury_location);
        $('.rate-3').html(top_property_damage_location);

        $('.location-name').html(name);


        // Change third-section-first-chart values
        var third_section_first_chart = $('#third-section-first-chart').highcharts();
        var third_section_first_chart_data = [];
        var url_for_chart_get_results = "{{ url_for('api.monthly_incidents', name='name', level=00, violence_type='violence-type')}}".replace('name',name).replace(0,level_number).replace('violence-type', violence_type);
         $.get(url_for_chart_get_results, function (data) {
             $.each(data.incidents, function (item) {
                third_section_first_chart_data[item] = data.incidents[item].death;
            });
        });
        third_section_first_chart.series[0].setData(third_section_first_chart_data);

        // Change third-section-second-chart values
        var third_section_second_chart = $('#third-section-second-chart').highcharts();
        var third_section_second_chart_data = [];
        $.get(url_for_chart_get_results, function (data) {
             $.each(data.incidents, function (item) {
                third_section_second_chart_data[item] = data.incidents[item].injuries;
            });
        });
        third_section_second_chart.series[0].setData(third_section_second_chart_data);

        // Change third-section-third-chart values
        var third_section_third_chart = $('#third-section-third-chart').highcharts();
        var third_section_third_chart_data = [];
        $.get(url_for_chart_get_results, function (data) {
             $.each(data.incidents, function (item) {
                third_section_third_chart_data[item] = data.incidents[item].property;
            });
        });
        third_section_third_chart.series[0].setData(third_section_third_chart_data);


        // Change the presentation text based on the level
        if(level_number == 0){
            $('.section-title').text('National Overview');
        }
        else if(level_number == 1){
            $('.section-title').text('Division Overview');

        }
        else{
            $('.section-title').text('District Overview');
        }


    }
    function getTopN(arr, prop, n) {
        // clone before sorting, to preserve the original array
        var clone = arr.slice(0);

        // sort descending
        clone.sort(function(x, y) {
            if (x[prop] == y[prop]) return 0;
            else if (parseInt(x[prop]) < parseInt(y[prop])) return 1;
            else return -1;
        });

        return clone.slice(0, n || 1);
    }
    function buildViolenceTypeDropDown() {
        // Get violence dropdown options instance
        var violence_options = $("#violence-type-select");

        // Get request to get the violence types
        $.get('{{ url_for("api.get_violence_types", dataset="mgr")}}', function (data) {
            $.each(data, function (item) {
                violence_options.append($("<option />").val(data[item]).text(data[item]));
            });
        });
    }

    function capitalize(s) {
        return s[0].toUpperCase() + s.slice(1);
    }
    function buildDataSeries(url) {
        var json_data = {};
        var divisions = {};
        var districts = {};
        var upazillas = {};

        $.get("{{ url_for('api.get_victims', type='division')}}", function (data) {
            for (var item in data) {
                divisions[data[item]['division'].toString()] = data[item]["incidents"]
            }
        });
        $.get("{{ url_for('api.get_victims', type='district')}}", function (data) {
            for (var item in data) {
                districts[data[item]['district'].toString()] = data[item]["incidents"]
            }
        });
        $.get("{{ url_for('api.get_victims', type='upazilla')}}", function (data) {
            for (var item in data) {
                upazillas[data[item]['upazilla']] = data[item]["incidents"]
            }
        });
        json_data['division'] = divisions;
        json_data['district'] = districts;
        json_data['upazilla'] = upazillas;
        return json_data;
    }
</script>
{% endblock %}